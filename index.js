require('dotenv').config();
const TelegramBot = require('node-telegram-bot-api');
const moment = require('moment-timezone');

const token = process.env.BOT_TOKEN;
const bot = new TelegramBot(token, { polling: true });

const bookings = new Map();
const userLanguage = new Map(); // To store user's language preference

// Language translations
const translations = {
  am: {
    welcome: '‘≤’°÷Ä’´ ’£’°’¨’∏÷Ç’Ω’ø üçΩÔ∏è\n‘Ω’∂’§÷Ä’∏÷Ç’¥ ’•’¥ ’®’∂’ø÷Ä’´÷Ä ’°’¥’Ω’°’©’´’æ’®’ù ÷Ö÷Ä’°÷Å’∏÷Ç’µ÷Å’´÷Å÷â',
    chooseDate: '‘Ω’∂’§÷Ä’∏÷Ç’¥ ’•’¥ ’®’∂’ø÷Ä’´÷Ä ’°’¥’Ω’°’©’´’æ’®’ù ÷Ö÷Ä’°÷Å’∏÷Ç’µ÷Å’´÷Å÷â',
    selectedDate: 'üìÜ ‘∏’∂’ø÷Ä’æ’°’Æ ÷Ö÷Ä’ù',
    chooseTime: '‘Ω’∂’§÷Ä’∏÷Ç’¥ ’•’¥ ’®’∂’ø÷Ä’´÷Ä ’™’°’¥’®÷â',
    selectedTime: 'üïí ‘∏’∂’ø÷Ä’æ’°’Æ ’™’°’¥’ù',
    choosePeople: '‘Ω’∂’§÷Ä’∏÷Ç’¥ ’•’¥ ’∂’∑’´÷Ä ’¥’°÷Ä’§’Ø’°’∂÷Å ÷Ñ’°’∂’°’Ø’®÷â',
    bookingSuccess: '‚úÖ ‘±’¥÷Ä’°’£÷Ä’∏÷Ç’¥’® ’∞’°’ª’∏’≤’∏÷Ç’©’µ’°’¥’¢ ’Ø’°’ø’°÷Ä’æ’°’Æ ’ß:',
    day: '’ï÷Ä',
    time: '‘∫’°’¥',
    people: '’Ñ’°÷Ä’§’´’Ø',
    address: '’Ä’°’Ω÷Å’•',
    bookAgain: 'üöÄ ’ç’Ø’Ω’•’¨ ’°’¥÷Ä’°’£÷Ä’∏÷Ç’¥’®',
    noBookingsToday: '‚ùå ‘±’µ’Ω÷Ö÷Ä’æ’° ’∞’°’¥’°÷Ä ’£÷Ä’°’∂÷Å’∏÷Ç’¥’∂’•÷Ä’∂ ’°’æ’°÷Ä’ø’æ’°’Æ ’•’∂÷â\n‘Ω’∂’§÷Ä’∏÷Ç’¥ ’•’∂÷Ñ ’®’∂’ø÷Ä’•’¨ ’∞’°’ª’∏÷Ä’§ ÷Ö÷Ä’•÷Ä’´÷Å ’¥’•’Ø’® üìÖ',
    viewOnMap: 'üìå ’ë’°’∂’Ø’°’∂’∏÷Ç’û’¥ ’•÷Ñ ’ø’•’Ω’∂’•’¨ ’¥’•÷Ä ’ø’•’≤’® ÷Ñ’°÷Ä’ø’•’¶’∏÷Ç’¥÷â ‘∏’∂’ø÷Ä’•÷Ñ ÷Ñ’°÷Ä’ø’•’¶’´ ’ø’•’Ω’°’Ø’®÷â',
    openGoogleMaps: 'üìç ‘≤’°÷Å’•’¨ Google Maps-’∏÷Ç’¥',
    openYandexMaps: 'üó∫Ô∏è ‘≤’°÷Å’•’¨ Yandex ’î’°÷Ä’ø’•’¶’∏÷Ç’¥',
    selectLanguage: `‘Ω’∂’§÷Ä’∏÷Ç’¥ ’•’¥, ’®’∂’ø÷Ä’•÷Ñ ’¨’•’¶’∏÷Ç’∂÷â\nPlease, choose a language.`,
    weekDays: ['‘ø÷Ä’Ø', '‘µ÷Ä÷Ñ', '’â÷Ä÷Ñ', '’Ä’∂’£', '’à÷Ç÷Ä’¢', '’á’¢’©', '‘ø’´÷Ä'],
    addressValue: '*3, 3a Sebastia St, Yerevan*',
  },
  ru: {
    welcome: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å üçΩÔ∏è\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏–∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è.',
    chooseDate: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏–∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è.',
    selectedDate: 'üìÜ –í—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞:',
    chooseTime: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è.',
    selectedTime: 'üïí –í—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è:',
    choosePeople: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ–ª–æ–≤–µ–∫.',
    bookingSuccess: '‚úÖ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ:',
    day: '–î–µ–Ω—å',
    time: '–í—Ä–µ–º—è',
    people: '–ß–µ–ª–æ–≤–µ–∫',
    address: '–ê–¥—Ä–µ—Å',
    bookAgain: 'üöÄ –ù–∞—á–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ',
    noBookingsToday: '‚ùå –ó–∞–ø–∏—Å–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å.\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ —Å–ª–µ–¥—É—é—â–∏—Ö –¥–Ω–µ–π üìÖ',
    viewOnMap: 'üìå –•–æ—Ç–∏—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞—à–µ –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ? –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫–∞—Ä—Ç—ã.',
    openGoogleMaps: 'üìç –û—Ç–∫—Ä—ã—Ç—å –≤ Google Maps',
    openYandexMaps: 'üó∫Ô∏è –û—Ç–∫—Ä—ã—Ç—å –≤ Yandex –ö–∞—Ä—Ç–∞—Ö',
    selectLanguage: '–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫.',
    weekDays: ['–ü–Ω–¥', '–í—Ç—Ä', '–°—Ä–¥', '–ß—Ç–≤', '–ü—Ç–Ω', '–°–±—Ç', '–í—Å–∫'],
    addressValue: '*3, 3a Sebastia St, Yerevan*',
  },
  en: {
    welcome: 'Welcome üçΩÔ∏è\nPlease select a date from the calendar.',
    chooseDate: 'Please select a date from the calendar.',
    selectedDate: 'üìÜ Selected Date:',
    chooseTime: 'Please select a time.',
    selectedTime: 'üïí Selected Time:',
    choosePeople: 'Please specify the number of people.',
    bookingSuccess: '‚úÖ Booking successfully completed:',
    day: 'Day',
    time: 'Time',
    people: 'People',
    address: 'Address',
    bookAgain: 'üöÄ Start Booking',
    noBookingsToday: '‚ùå Bookings for today are full.\nPlease select one of the following days üìÖ',
    viewOnMap: 'üìå Do you want to see our location on the map? Choose the map type.',
    openGoogleMaps: 'üìç Open in Google Maps',
    openYandexMaps: 'üó∫Ô∏è Open in Yandex Maps',
    selectLanguage: 'Select Language.',
    weekDays: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
    addressValue: '*3, 3a Sebastia St, Yerevan*',
  },
};

function getTranslation(userId, key) {
  const lang = userLanguage.get(userId) || 'am'; // Default to Armenian
  return translations[lang][key];
}

function getLanguageKeyboard() {
  return {
    reply_markup: {
      inline_keyboard: [
        [{ text: '’Ä’°’µ’•÷Ä’•’∂ üá¶üá≤', callback_data: 'lang_am' }],
        [{ text: '–†—É—Å—Å–∫–∏–π üá∑üá∫', callback_data: 'lang_ru' }],
        [{ text: 'English üá¨üáß', callback_data: 'lang_en' }],
      ],
    },
  };
}

function getCalendarKeyboard(year, month, userId) {
  const today = moment().tz('Asia/Yerevan').startOf('day');
  const currentMonth = moment.tz([year, month], 'Asia/Yerevan');
  const daysInMonth = currentMonth.daysInMonth();
  const startDay = (currentMonth.startOf('month').day() + 6) % 7; // Adjust for Monday start

  const keyboard = [];
  const monthName = currentMonth.format('MMMM');
  keyboard.push([{ text: `üóìÔ∏è ${monthName}`, callback_data: 'ignore' }]);

  const weekDays = getTranslation(userId, 'weekDays');
  keyboard.push(weekDays.map((d) => ({ text: d, callback_data: 'ignore' })));

  let row = new Array(startDay).fill({ text: ' ', callback_data: 'ignore' });

  for (let day = 1; day <= daysInMonth; day++) {
    const date = moment.tz([year, month, day], 'Asia/Yerevan').startOf('day');
    const dateStr = date.format('YYYY-MM-DD');

    if (date.isBefore(today)) {
      row.push({ text: `üîí${day}`, callback_data: 'ignore' });
    } else if (date.isSame(today)) {
      row.push({ text: `üìç${day}`, callback_data: `date_${dateStr}` });
    } else {
      row.push({ text: `${day}`, callback_data: `date_${dateStr}` });
    }

    if (row.length === 7) {
      keyboard.push(row);
      row = [];
    }
  }

  if (row.length > 0) {
    while (row.length < 7) row.push({ text: ' ', callback_data: 'ignore' });
    keyboard.push(row);
  }

  const next = moment([year, month]).add(1, 'month');
  keyboard.push([
    { text: '‚û°Ô∏è', callback_data: `month_${next.year()}_${next.month()}` },
  ]);

  return { reply_markup: { inline_keyboard: keyboard } };
}

function getTimeOptions(dateString, userId) {
  const now = moment().tz('Asia/Yerevan');
  const selectedDate = moment.tz(dateString, 'YYYY-MM-DD', 'Asia/Yerevan');
  const buttons = [];
  let row = [];

  for (let hour = 10; hour <= 22; hour++) {
    const timeSlot = selectedDate.clone().hour(hour).minute(0);
    if (selectedDate.isAfter(now, 'day') || timeSlot.isAfter(now)) {
      row.push({
        text: `üïí ${hour}:00`,
        callback_data: `time_${dateString}_${hour}`,
      });

      if (row.length === 3) {
        buttons.push(row);
        row = [];
      }
    }
  }

  if (row.length > 0) buttons.push(row);

  return { reply_markup: { inline_keyboard: buttons } };
}

function getPeopleOptions(date, hour, userId) {
  return {
    reply_markup: {
      inline_keyboard: [
        [{ text: `üë§ 1-2 ${getTranslation(userId, 'people')}`, callback_data: `people_${date}_${hour}_1-2` }],
        [{ text: `üë• 2-4 ${getTranslation(userId, 'people')}`, callback_data: `people_${date}_${hour}_2-4` }],
        [{ text: `üë®‚Äçüë©‚Äçüëß‚Äçüë¶ 4+ ${getTranslation(userId, 'people')}`, callback_data: `people_${date}_${hour}_4+` }],
      ],
    },
  };
}

bot.onText(/\/start/, (msg) => {
  const chatId = msg.chat.id;
  bot.sendMessage(chatId, getTranslation(chatId, 'selectLanguage'), getLanguageKeyboard());
});

bot.on('callback_query', (callbackQuery) => {
  const data = callbackQuery.data;
  const chatId = callbackQuery.message.chat.id;
  const userId = callbackQuery.from.id;

  if (data === 'ignore') return bot.answerCallbackQuery(callbackQuery.id);

  if (data.startsWith('lang_')) {
    const lang = data.split('_')[1];
    userLanguage.set(userId, lang);
    const now = moment().tz('Asia/Yerevan');
    const year = now.year();
    const month = now.month();
    bot.sendMessage(chatId, getTranslation(userId, 'welcome'), getCalendarKeyboard(year, month, userId));
    return bot.answerCallbackQuery(callbackQuery.id);
  }

  if (!userLanguage.has(userId)) {
    // If language is not set, prompt for language selection again
    bot.sendMessage(chatId, getTranslation(chatId, 'selectLanguage'), getLanguageKeyboard());
    return bot.answerCallbackQuery(callbackQuery.id);
  }

  if (data.startsWith('month_')) {
    const [, y, m] = data.split('_');
    return bot.editMessageReplyMarkup(
      getCalendarKeyboard(parseInt(y), parseInt(m), userId).reply_markup,
      {
        chat_id: chatId,
        message_id: callbackQuery.message.message_id,
      }
    );
  }

  if (data.startsWith('date_')) {
    const selectedDate = data.split('_')[1];
    bookings.set(userId, { date: selectedDate });

    const timeOptions = getTimeOptions(selectedDate, userId);
    if (timeOptions.reply_markup.inline_keyboard.length === 0) {
      bot.sendMessage(chatId, getTranslation(userId, 'noBookingsToday'));
      return;
    }

    bot.sendMessage(chatId, `${getTranslation(userId, 'selectedDate')} ${selectedDate}\n${getTranslation(userId, 'chooseTime')}`, timeOptions);
  }

  else if (data.startsWith('time_')) {
    const [, date, hour] = data.split('_');
    const booking = bookings.get(userId) || {};
    booking.date = date;
    booking.hour = hour;
    bookings.set(userId, booking);

    bot.sendMessage(chatId, `${getTranslation(userId, 'selectedTime')} ${hour}:00\n${getTranslation(userId, 'choosePeople')}`, getPeopleOptions(date, hour, userId));
  }

  else if (data.startsWith('people_')) {
    const [, date, hour, people] = data.split('_');
    const booking = bookings.get(userId) || {};
    booking.people = people;
    bookings.set(userId, booking);

    // ‚úÖ ‘±’¥÷Ä’°’£÷Ä’∏÷Ç’¥
    bot.sendMessage(
      chatId,
      `${getTranslation(userId, 'bookingSuccess')}\nüìÜ ${getTranslation(userId, 'day')}’ù ${date}\nüïí ${getTranslation(userId, 'time')}’ù ${hour}:00\nüë• ${getTranslation(userId, 'people')}’ù ${people}\nüìç ${getTranslation(userId, 'address')}’ù ${getTranslation(userId, 'addressValue')}`,
      {
        parse_mode: 'Markdown',
        reply_markup: {
          keyboard: [[{ text: getTranslation(userId, 'bookAgain') }]],
          resize_keyboard: true,
          one_time_keyboard: false,
        },
      }
    );

    // ’î’°÷Ä’ø’•’¶’´ ’®’∂’ø÷Ä’∏÷Ç’©’µ’∏÷Ç’∂
    bot.sendMessage(chatId, getTranslation(userId, 'viewOnMap'), {
      reply_markup: {
        inline_keyboard: [
          [
            {
              text: getTranslation(userId, 'openGoogleMaps'),
              url: 'https://www.google.com/maps?q=40.188770,44.462507',
            },
          ],
          [
            {
              text: getTranslation(userId, 'openYandexMaps'),
              url: 'https://yandex.com/maps/?ll=44.462507,40.188770&z=17&pt=44.462507,40.188770~flag',
            },
          ],
        ],
      },
    });

    // ’é’•÷Ä’ª’∏÷Ç’¥ ’∏÷Ç’≤’´’≤ ÷Ñ’°÷Ä’ø’•’¶
    bot.sendLocation(chatId, 40.188770, 44.462507);

    bookings.delete(userId);
  }

  bot.answerCallbackQuery(callbackQuery.id);
});

bot.on('message', (msg) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;
  const text = msg.text;

  if (!userLanguage.has(userId)) {
    // If language is not set, prompt for language selection again
    bot.sendMessage(chatId, getTranslation(chatId, 'selectLanguage'), getLanguageKeyboard());
    return;
  }

  if (text === getTranslation(userId, 'bookAgain')) {
    const now = moment().tz('Asia/Yerevan');
    const year = now.year();
    const month = now.month();

    bot.sendMessage(
      chatId,
      getTranslation(userId, 'chooseDate'),
      {
        ...getCalendarKeyboard(year, month, userId),
        reply_markup: {
          ...getCalendarKeyboard(year, month, userId).reply_markup,
          remove_keyboard: true,
        },
      }
    );
  } else {
    bot.sendMessage(chatId, `${getTranslation(userId, 'welcome')}\n${getTranslation(userId, 'bookAgain')}`, {
      reply_markup: {
        keyboard: [[{ text: getTranslation(userId, 'bookAgain') }]],
        resize_keyboard: true,
        one_time_keyboard: false,
      },
    });
  }
});